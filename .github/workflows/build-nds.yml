name: Build NDS Examples

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up devkitPro
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget https://apt.devkitpro.org/devkitpro-keyring.gpg
        sudo install -o root -g root -m 644 devkitpro-keyring.gpg /usr/share/keyrings/devkitpro.gpg
        echo "deb [signed-by=/usr/share/keyrings/devkitpro.gpg] https://apt.devkitpro.org/ stable main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update
        sudo apt-get install -y devkitarm libnds nds-dev

    - name: Set environment variables
      run: |
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV

    - name: Build NDS examples
      run: |
        for d in */ ; do
          if [ -f "$d/Makefile" ]; then
            echo "::group::Building $d"
            make -C "$d" || echo "Failed to build $d"
            echo "::endgroup::"
          fi
        done

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nds-builds
        path: |
          **/*.nds
